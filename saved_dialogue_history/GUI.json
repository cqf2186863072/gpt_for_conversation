[{"role": "system", "content": "\u4f60\u662f\u7f16\u7a0b\u9ad8\u624b"}, {"role": "user", "content": "\u8bf7\u8bb0\u4f4f\u4e0b\u9762\u7684\u4ee3\u7801\n```python\nimport re\nimport os\nimport configparser\nimport json\nimport threading\nimport time\nimport azure_module\nfrom datetime import datetime\nfrom enum import Enum\nfrom gpt_module import GPTClient\n\n\n\nclass InputMode(Enum):\n    KEYBOARD = 0\n    VOICE = 1\n\nclass OutputMode(Enum):\n    PRINT = 0\n    SPEAK = 1\n\nclass CheckResult(Enum):\n    BREAK = 0\n    CONTINUE = 1\n\nclass Message:\n    def __init__(self, role, content):\n        self.role = role\n        self.content = content\n\n    def to_dict(self):\n        return {\"role\": f\"{self.role}\", \"content\": self.content}\n\nclass DialogueManager:\n    def __init__(self, gpt_client, synthesizer=None, recognizer=None, parent=None):\n        '''\u5bf9\u8bdd\u7ba1\u7406\u5668\u521d\u59cb\u5316\u65b9\u6cd5\n        \n        Args:\n            gpt_client: gpt_client\u5b9e\u4f8b(GPTClient.py)\n            synthesizer: synthesizer\u5b9e\u4f8b(azure_module.py)\n            recognizer: recognizer\u5b9e\u4f8b(azure_module.py)\n            parent: gui\u4e3b\u7a97\u53e3\u5b9e\u4f8b(gui.py)\n\n        '''\n        self.gpt_client = gpt_client\n        self.synthesizer = synthesizer\n        self.recognizer = recognizer\n        self.parent = parent\n        self.set_prompt()\n        self.init_keywords()\n\n    def init_keywords(self):\n        self.InputMode = InputMode.KEYBOARD\n        self.OutputMode = OutputMode.PRINT\n\n        self.set_prompt_words = [\"\u8bbe\u7f6e\", \"set\"]\n        self.set_prompt_pattern = self.build_pattern(self.set_prompt_words)\n\n        self.save_dialogue_words = [\"\u4fdd\u5b58\", \"save\"]\n        self.save_dialogue_pattern = self.build_pattern(self.save_dialogue_words)\n\n        self.switch_OutputMode_words = [\"\u5207\u6362\u8f93\u51fa\u6a21\u5f0f\", \"\u8bed\u97f3\"]\n        self.switch_OutputMode_pattern = self.build_pattern(self.switch_OutputMode_words)\n\n        self.switch_InputMode_words = [\"\u5207\u6362\u8f93\u5165\u6a21\u5f0f\", \"\u5207\u6362\", \"switch\", \"change\", \"toggle\"]\n        self.switch_InputMode_pattern = self.build_pattern(self.switch_InputMode_words)\n\n        self.multiline_words = [\"\u591a\u884c\", \"multiline\"]\n        self.multiline_pattern = self.build_pattern(self.multiline_words)\n\n        self.exit_words = [\"\u9000\u51fa\", \"\u7ed3\u675f\", \"\u505c\u6b62\", \"exit\", \"end\", \"quit\"]\n        self.exit_pattern = self.build_pattern(self.exit_words)\n\n    def build_pattern(self, words):\n        return \"|\".join([f\"^({word})[\u3002.]?\\s*$\" for word in words])\n\n    def check_key_words(self):\n        self.CheckResult = None\n\n        if re.match(self.set_prompt_pattern, self.user_input):\n            prompt_text = input(\"\u8bf7\u8f93\u5165prompt(system's content)\uff08\u4e0d\u9700\u8981\u5c31Enter\uff09\uff1a\")\n            prompt_file = input(\"\u8bf7\u8f93\u5165\u5bf9\u8bdd\u8bb0\u5f55\u6587\u4ef6\u540d\uff08\u4e0d\u9700\u8981\u5c31Enter\uff09\uff1a\")\n            self.set_prompt(prompt_text=prompt_text, prompt_file=prompt_file)\n            self.CheckResult = CheckResult.CONTINUE\n        if re.match(self.save_dialogue_pattern, self.user_input):\n            self.save_dialogue()\n            self.CheckResult = CheckResult.CONTINUE\n        if re.match(self.switch_OutputMode_pattern, self.user_input):\n            self.switch_OutputMode()\n            self.CheckResult = CheckResult.CONTINUE\n        if re.match(self.switch_InputMode_pattern, self.user_input):\n            self.switch_InputMode()\n            self.CheckResult = CheckResult.CONTINUE\n\n\n        if re.match(self.multiline_pattern, self.user_input):\n            self.user_input = self.get_multiline_input()\n\n        if re.match(self.exit_pattern, self.user_input):\n            self.exit_flag = True\n            self.CheckResult = CheckResult.BREAK\n\n    def set_prompt(self, prompt_text=None, prompt_file=None):\n        '''\u7528\u6765\u8bbe\u7f6eprompt\u7684\u65b9\u6cd5\n\n        Args:\n            prompt_text: \u6587\u672c\u5f62\u5f0f\u7684prompt\n            prompt_file: \u6587\u4ef6\u5f62\u5f0f\u7684prompt\n\n        '''\n        if prompt_file:\n            try:\n                file_name = os.path.join('saved_dialogue_history', prompt_file + '.json')\n                if os.path.exists(file_name):\n                    # with open(file_name, 'r', encoding='utf-8') as file:\n                    with open(file_name, 'r') as file:\n                        self.dialogue_history = json.load(file)\n                    print(f\"'{file_name}'\u521d\u59cb\u5316\u6210\u529f\")\n                else:\n                    raise Exception(f'\u672a\u627e\u5230\u6587\u4ef6{file_name}')\n            except Exception as e:\n                print(e)\n        elif prompt_text:\n            self.dialogue_history = [{\"role\": \"system\", \"content\": f'{prompt_text}'}]\n            print(f\"'{prompt_text}'\u521d\u59cb\u5316\u6210\u529f\")\n        else:\n            self.dialogue_history = [{\"role\": \"system\", \"content\": ''}]\n            print(\"\u672a\u8bbe\u7f6eprompt\")\n\n    def save_dialogue(self, file_name=None):\n        if not file_name:\n            file_name = input(\"\u8bf7\u8f93\u5165\u8981\u4fdd\u5b58\u7684\u6587\u4ef6\u540d\uff1a\")\n\n        # \u521b\u5efa'saved_dialogue_history'\u6587\u4ef6\u5939\n        if not os.path.exists('saved_dialogue_history'):\n            os.makedirs('saved_dialogue_history')\n\n        # \u5c06\u5bf9\u8bdd\u8bb0\u5f55\u4fdd\u5b58\u4e3ajson\u6587\u4ef6\n        with open(os.path.join('saved_dialogue_history', file_name + '.json'), 'w') as file:\n            json.dump(self.dialogue_history, file)\n\n        # \u5c06\u5bf9\u8bdd\u8bb0\u5f55\u4fdd\u5b58\u4e3atxt\u6587\u4ef6\n        with open(os.path.join('saved_dialogue_history', file_name + '.txt'), 'w', encoding='utf-8') as file:\n            for message in self.dialogue_history:\n                file.write(f\"{message['role']}: {message['content']}\\n\")\n\n        print(\"\u5bf9\u8bdd\u8bb0\u5f55\u5df2\u4fdd\u5b58\")\n\n    def switch_OutputMode(self):\n        if self.OutputMode == OutputMode.PRINT:\n            if self.synthesizer:\n                self.OutputMode = OutputMode.SPEAK\n                self.output(\"\u5df2\u5207\u6362\u5230\u8bed\u97f3\u8f93\u51fa\u6a21\u5f0f\")\n            else:\n                print(\"\u62b1\u6b49\uff0c\u8bed\u97f3\u8f93\u51fa\u6a21\u5f0f\u4e0d\u53ef\u7528\")\n        else:\n            self.OutputMode = OutputMode.PRINT\n            print(\"\u5df2\u5207\u6362\u5230\u6587\u672c\u8f93\u51fa\u6a21\u5f0f\uff0c\u8bf7\u8f93\u5165\")\n\n    def switch_InputMode(self):\n        if self.InputMode == InputMode.KEYBOARD:\n            if self.recognizer:\n                self.InputMode = InputMode.VOICE\n                self.output(\"\u5df2\u5207\u6362\u5230\u8bed\u97f3\u8f93\u5165\u6a21\u5f0f\uff0c\u8bf7\u8bf4\u8bdd\")\n            else:\n                print(\"\u62b1\u6b49\uff0c\u8bed\u97f3\u8f93\u5165\u6a21\u5f0f\u4e0d\u53ef\u7528\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u8f93\u5165\")\n        else:\n            self.InputMode = InputMode.KEYBOARD\n            print(\"\u5df2\u5207\u6362\u5230\u952e\u76d8\u8f93\u5165\u6a21\u5f0f\uff0c\u8bf7\u8f93\u5165\")\n\n    def get_multiline_input(self):\n        print(\"\u8bf7\u8f93\u5165\u591a\u884c\u5185\u5bb9\uff0c\u4ee5END\u7ed3\u675f\")\n        lines = []\n        while True:\n            line = input()\n            if line == \"END\":\n                break\n            lines.append(line)\n        return \"\\n\".join(lines)\n\n    def show_loading(self):\n        start_time = time.time()\n        while self.loading_flag:\n            print('\u52a0\u8f7d\u4e2d...', end='\\r')\n            time.sleep(2)\n            if time.time() - start_time > 60:\n                print('\u957f\u65f6\u95f4\u672a\u54cd\u5e94\uff0c\u5efa\u8bae\u7ed3\u675f\u7a0b\u5e8f')\n                break\n\n    def output(self, text):\n        if self.synthesizer and self.OutputMode == OutputMode.SPEAK:\n            self.synthesizer.text_to_speech_speaker(text)\n        print(f\"assistant: {text}\")\n        print(\"\\n----------\")\n\n    def send_and_receive(self):\n        text = self.gpt_client.send_request(self.dialogue_history)\n        self.loading_flag = False\n        self.output(text)\n        assistant_message = Message(\"assistant\", text)\n        self.dialogue_history.append(assistant_message.to_dict())\n\n    def run(self):\n        self.exit_flag = False\n        self.loading_flag = False\n        while not self.exit_flag:\n            try:\n                # \u83b7\u53d6\u7528\u6237\u8f93\u5165\n                if self.InputMode == InputMode.VOICE:\n                    print(\"User: \")\n                    self.user_input = self.recognizer.speech_to_text_microphone()\n                    print(self.user_input)\n                else:\n                    self.user_input = input(\"User: \")\n\n                # \u68c0\u67e5\u5173\u952e\u8bcd\n                self.check_key_words()\n                if self.CheckResult == CheckResult.BREAK:\n                    break\n                elif self.CheckResult == CheckResult.CONTINUE:\n                    continue\n\n                # \u5c06\u7528\u6237\u8f93\u5165\u52a0\u5165\u5bf9\u8bdd\u5386\u53f2\n                user_message = Message(\"user\", self.user_input)\n                self.dialogue_history.append(user_message.to_dict())\n                print(\"\\n----------\")\n                \n                # \u542f\u52a8\u5e76\u7b49\u5f85\u7ebf\u7a0b\u7ed3\u675f\n                self.loading_flag = True\n                t1 = threading.Thread(target=self.send_and_receive)\n                t1.start()\n                t2 = threading.Thread(target=self.show_loading)\n                t2.start()\n                t1.join()\n                t2.join()\n\n            except Exception as e:\n                print(f\"Error: {e}\")\n                break\n        print('\u611f\u8c22\u60a8\u4f7f\u7528\u672c\u7a0b\u5e8f\uff0c\u518d\u89c1\uff01')\n\nif __name__ == '__main__':\n    gpt_client = GPTClient()\n\n    # # \u914d\u7f6eazure\n    # selector = azure_module.LanguageAndVoiceSelector(timeout=3)\n    # language, voice = selector.choose_language_and_voice()\n    # speech_synthesizer = azure_module.SpeechSynthesizer(language, voice)\n    # speech_recognizer = azure_module.SpeechRecognizer(language)\n\n    # # \u5e26\u6709\u8bed\u97f3\u7cfb\u7edf\u7684\u5bf9\u8bdd\u52a9\u624b\n    # dialogue_manager = DialogueManager(gpt_client, speech_synthesizer, speech_recognizer)\n\n    # \u8fd0\u884c\u5bf9\u8bdd\u7cfb\u7edf\n    dialogue_manager = DialogueManager(gpt_client)\n    dialogue_manager.run()\n```\n"}, {"role": "assistant", "content": "\u5df2\u7ecf\u8bb0\u4f4f\u4e86\u8fd9\u6bb5\u4ee3\u7801\u3002\u8fd9\u662f\u4e00\u4e2a\u4f7f\u7528Python\u7f16\u5199\u7684\u5bf9\u8bdd\u7ba1\u7406\u5668\uff0c\u5b83\u53ef\u4ee5\u4e0eGPT-3\u6a21\u578b\u8fdb\u884c\u4ea4\u4e92\u5e76\u652f\u6301\u6587\u672c\u548c\u8bed\u97f3\u8f93\u5165\u8f93\u51fa\u3002\u4ee3\u7801\u4e2d\u5305\u542b\u4e86\u4e00\u4e9b\u5173\u952e\u7684\u7c7b\u548c\u65b9\u6cd5\uff0c\u5982DialogueManager\u3001Message\u3001set_prompt\u7b49\u3002\u5982\u679c\u60a8\u6709\u5173\u4e8e\u8fd9\u6bb5\u4ee3\u7801\u7684\u4efb\u4f55\u95ee\u9898\uff0c\u8bf7\u968f\u65f6\u8be2\u95ee\u3002"}, {"role": "user", "content": "\u518d\u8bb0\u4f4f\u8fd9\u6bb5\u4ee3\u7801\n```\nfrom gpt_module import GPTClient\nfrom dialogue_module import Message\nfrom dialogue_module import DialogueManager\nfrom PyQt5.QtWidgets import QApplication, QMainWindow, QTextEdit, QLineEdit, QPushButton, QVBoxLayout, QWidget, QFileDialog, QLabel, QHBoxLayout, QRadioButton, QInputDialog, QSizePolicy, QPlainTextEdit, QSplitter\nfrom PyQt5.QtCore import Qt, QThreadPool, QRunnable, pyqtSlot\nimport traceback\nimport sys\n\nclass GPTWorker(QRunnable):\n    def __init__(self, dialogue_manager, user_message):\n        super(GPTWorker, self).__init__()\n        self.dialogue_manager = dialogue_manager\n        self.user_message = user_message\n\n    @pyqtSlot()\n    def run(self):\n        try:\n            # \u5c06\u7528\u6237\u8f93\u5165\u52a0\u5165\u5bf9\u8bdd\u5386\u53f2\n            user_message_obj = Message(\"user\", self.user_message)\n            self.dialogue_manager.dialogue_history.append(user_message_obj.to_dict())\n\n            # \u83b7\u53d6AI\u52a9\u624b\u7684\u56de\u590d\n            assistant_message = self.dialogue_manager.gpt_client.send_request(self.dialogue_manager.dialogue_history)\n            assistant_message_obj = Message(\"assistant\", assistant_message)\n            self.dialogue_manager.dialogue_history.append(assistant_message_obj.to_dict())\n\n            self.dialogue_manager.parent.receive_message(assistant_message)\n\n        except Exception as e:\n            print(\"Error in GPTWorker:\", e)\n            traceback.print_exc()\n\nclass App(QMainWindow):\n    def __init__(self, dialogue_manager):\n        super().__init__()\n        self.dialogue_manager = dialogue_manager\n        self.dialogue_manager.parent = self\n        self.init_ui()\n\n    def init_ui(self):\n        self.setWindowTitle(\"AI\u52a9\u624b\")\n\n        # \u521b\u5efa\u4e00\u4e2a\u5782\u76f4\u5e03\u5c40\n        layout = QVBoxLayout()\n\n        # \u521b\u5efa\u4e00\u4e2a\u5206\u9694\u6761\n        splitter = QSplitter(Qt.Vertical)\n        \n\n        # \u521b\u5efa\u4e00\u4e2a\u6587\u672c\u7f16\u8f91\u5668\u6765\u663e\u793a\u5bf9\u8bdd\u5386\u53f2\n        self.conversation_history = QTextEdit()\n        self.conversation_history.setReadOnly(True)\n        # layout.addWidget(self.conversation_history, stretch=3)\n        splitter.addWidget(self.conversation_history)\n\n        # \u521b\u5efa\u4e00\u4e2a\u8f93\u5165\u6846\u4f9b\u7528\u6237\u8f93\u5165\u6587\u672c\n        self.user_input = QPlainTextEdit()\n        # self.user_input.setFixedHeight(100)\n        # layout.addWidget(self.user_input)\n        splitter.addWidget(self.user_input)\n\n        layout.addWidget(splitter)\n\n        # \u521b\u5efa\u4e00\u4e2a\u53d1\u9001\u6309\u94ae\u6765\u89e6\u53d1\u6d88\u606f\u53d1\u9001\n        self.send_button = QPushButton(\"\u53d1\u9001\")\n        self.send_button.clicked.connect(self.send_message)\n        layout.addWidget(self.send_button)\n\n        # \u521b\u5efa\u529f\u80fd\u6309\u94ae\n        self.init_feature_buttons(layout)\n\n        # \u8bbe\u7f6e\u7a97\u53e3\u7684\u5e03\u5c40\n        container = QWidget()\n        container.setLayout(layout)\n        self.setCentralWidget(container)\n\n    def init_feature_buttons(self, layout):\n        # \u521b\u5efa\u4e00\u4e2a\u6c34\u5e73\u5e03\u5c40\n        hbox = QHBoxLayout()\n\n        # \u521b\u5efa\u8bbe\u7f6ePrompt\u6309\u94ae\n        self.set_prompt_button = QPushButton(\"\u8bbe\u7f6ePrompt\")\n        self.set_prompt_button.clicked.connect(self.set_prompt)\n        hbox.addWidget(self.set_prompt_button)\n\n        # \u521b\u5efa\u4fdd\u5b58\u5bf9\u8bdd\u6309\u94ae\n        self.save_dialogue_button = QPushButton(\"\u4fdd\u5b58\u5bf9\u8bdd\")\n        self.save_dialogue_button.clicked.connect(self.save_dialogue)\n        hbox.addWidget(self.save_dialogue_button)\n\n        # # \u521b\u5efa\u5207\u6362\u8f93\u5165\u6a21\u5f0f\u6309\u94ae\n        # switch_input_mode_button = QPushButton(\"\u5207\u6362\u8f93\u5165\u6a21\u5f0f\")\n        # switch_input_mode_button.clicked.connect(self.switch_input_mode)\n        # hbox.addWidget(switch_input_mode_button)\n\n        # # \u521b\u5efa\u5207\u6362\u8f93\u51fa\u6a21\u5f0f\u6309\u94ae\n        # switch_output_mode_button = QPushButton(\"\u5207\u6362\u8f93\u51fa\u6a21\u5f0f\")\n        # switch_output_mode_button.clicked.connect(self.switch_output_mode)\n        # hbox.addWidget(switch_output_mode_button)\n\n        layout.addLayout(hbox)\n\n    def send_message(self):\n        user_message = self.user_input.toPlainText()\n        if not user_message:\n            return\n\n        self.conversation_history.append(f\"User: {user_message}\")\n        self.user_input.clear()\n\n        # \u7981\u7528\u53d1\u9001\u548c\u8bbe\u7f6ePrompt\u6309\u94ae\n        self.send_button.setEnabled(False)\n        self.set_prompt_button.setEnabled(False)\n\n        # \u521b\u5efaGPTWorker\u5e76\u5c06\u5176\u6dfb\u52a0\u5230\u7ebf\u7a0b\u6c60\n        gpt_worker = GPTWorker(self.dialogue_manager, user_message)\n        QThreadPool.globalInstance().start(gpt_worker)\n\n    @pyqtSlot(str)\n    def receive_message(self, assistant_message):\n        # GPT\u8bf7\u6c42\u5b8c\u6210\u540e\u66f4\u65b0UI\n        self.conversation_history.append(f\"Assistant: {assistant_message}\")\n        self.send_button.setEnabled(True)\n        self.set_prompt_button.setEnabled(True)\n\n    def set_prompt(self):\n        prompt_text, ok = QInputDialog.getText(self, \"\u8bbe\u7f6ePrompt\", \"\u8bf7\u8f93\u5165prompt(system's content)\uff08\u4e0d\u9700\u8981\u5c31Enter\uff09\uff1a\")\n        if ok:\n            self.dialogue_manager.set_prompt(prompt_text=prompt_text)\n\n    def save_dialogue(self):\n        file_name, ok = QInputDialog.getText(self, \"\u4fdd\u5b58\u5bf9\u8bdd\", \"\u8bf7\u8f93\u5165\u8981\u4fdd\u5b58\u7684\u6587\u4ef6\u540d\uff1a\")\n        if ok and file_name:\n            self.dialogue_manager.save_dialogue(file_name)\n        elif ok:\n            self.dialogue_manager.save_dialogue()\n\n    def switch_input_mode(self):\n        self.dialogue_manager.switch_InputMode()\n\n    def switch_output_mode(self):\n        self.dialogue_manager.switch_OutputMode()\n\nif __name__ == \"__main__\":\n    gpt_client = GPTClient()\n    dialogue_manager = DialogueManager(gpt_client)\n\n    app = QApplication(sys.argv)\n    main_window = App(dialogue_manager)\n    main_window.show()\n    sys.exit(app.exec_())\n```"}, {"role": "assistant", "content": "\u5df2\u7ecf\u8bb0\u4f4f\u4e86\u8fd9\u6bb5\u4ee3\u7801\u3002\u8fd9\u662f\u4e00\u4e2a\u4f7f\u7528Python\u548cPyQt5\u7f16\u5199\u7684\u56fe\u5f62\u7528\u6237\u754c\u9762(GUI)\u5e94\u7528\u7a0b\u5e8f\uff0c\u5b83\u4e0e\u4e4b\u524d\u63d0\u4f9b\u7684\u5bf9\u8bdd\u7ba1\u7406\u5668\u4e00\u8d77\u5de5\u4f5c\u3002\u4ee3\u7801\u4e2d\u5305\u542b\u4e86\u4e00\u4e9b\u5173\u952e\u7684\u7c7b\u548c\u65b9\u6cd5\uff0c\u5982GPTWorker\u3001App\u7b49\u3002\u8fd9\u4e2aGUI\u5e94\u7528\u7a0b\u5e8f\u5305\u62ec\u4e00\u4e2a\u6587\u672c\u7f16\u8f91\u5668\u7528\u4e8e\u663e\u793a\u5bf9\u8bdd\u5386\u53f2\uff0c\u4e00\u4e2a\u8f93\u5165\u6846\u4f9b\u7528\u6237\u8f93\u5165\u6587\u672c\uff0c\u4ee5\u53ca\u4e00\u4e9b\u529f\u80fd\u6309\u94ae\uff0c\u5982\u8bbe\u7f6ePrompt\u3001\u4fdd\u5b58\u5bf9\u8bdd\u7b49\u3002\u5982\u679c\u60a8\u6709\u5173\u4e8e\u8fd9\u6bb5\u4ee3\u7801\u7684\u4efb\u4f55\u95ee\u9898\uff0c\u8bf7\u968f\u65f6\u8be2\u95ee\u3002"}]